---
import Card from './Card.astro';

interface Props {
  items: any[];
}

const { items } = Astro.props;

const cleanItems = items.map((item) => {
  const data = item.frontmatter || item.data || item; 
  return {
    ...data,
    slug: item.url || item.slug 
  };
});

// Clases Responsivas Estrictas
// Regla: Solo el primero tiene ancho máximo. El resto: (Ancho Máximo - 1)
const getResponsiveClass = (span: number, isFirst: boolean) => {
  // Mobile: Siempre 1
  let classes = 'col-span-1';

  const mdSpan = isFirst ? 2 : 1; 
  classes += ` md:col-span-${mdSpan}`;
  classes += ` lg:col-span-${span}`;
  return classes;
};

// Algoritmo Aleatorio para asignar spans
const getRandomLayout = (data: any[]) => {
  if (data.length === 0) return [];

  const processed = [];

  // El Primero siempre es el Rey (Hero)
  processed.push({ ...data[0], span: 4 });

  // El resto se decide por combinaciones aleatorias
  let i = 1;
  while (i < data.length) {
    const remaining = data.length - i;
    let pattern: number[] = [];

    // Patrones válidos para filas de ancho 4 (Ningún componente > 3)
    if (remaining >= 3) {
      // Si quedan 3 o más, tiramos un dado para elegir la estructura de la fila
      const dice = Math.random();
      if (dice < 0.20) pattern = [1, 1, 2];      // Fila de 3 items
      else if (dice < 0.40) pattern = [1, 2, 1]; // Fila de 3 items
      else if (dice < 0.60) pattern = [2, 1, 1]; // Fila de 3 items
      else if (dice < 0.80) pattern = [2, 2];    // Fila de 2 items (Equilibrada)
      else if (dice < 0.90) pattern = [3, 1];    // Fila de 2 items (Asimétrica)
      else pattern = [1, 3];                     // Fila de 2 items (Asimétrica)
    } 
    else if (remaining === 2) {
      // Si quedan solo 2, elegimos entre pares
      const dice = Math.random();
      if (dice < 0.4) pattern = [2, 2];
      else if (dice < 0.7) pattern = [3, 1];
      else pattern = [1, 3];
    } 
    else {
      // Si queda solo 1 huérfano, le damos 3 para que se vea grande pero no "Hero"
      pattern = [3];
    }

    // Asignar los anchos del patrón a los items disponibles
    pattern.forEach((spanValue, index) => {
      if (data[i + index]) {
        processed.push({ ...data[i + index], span: spanValue });
      }
    });

    i += pattern.length;
  }

  return processed;
};

const bentoItems = getRandomLayout(cleanItems);
---

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 w-full p-3 auto-rows-fr grid-flow-dense">
  {bentoItems.map((item, index) => (
    <Card
      {...item}
      span={item.span}
      class={getResponsiveClass(item.span, index === 0)}
    />
  ))}
</div>
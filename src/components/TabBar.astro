---
// src/components/TabBar.astro
import type { HTMLAttributes } from 'astro/types';

interface Tab {
  id: string;
  label: string;
}

interface Props extends HTMLAttributes<'div'> {
  tabs: Tab[];
  initialTabId: string;
  theme?: "sunset" | "cosmic"; 
  id?: string;
}

const { 
  tabs, 
  initialTabId, 
  id = "main-tab",
  class: className, 
  ...rest 
} = Astro.props;

// --- Estilos Base ---
const indicatorBaseStyle = "tab-indicator absolute top-1 bottom-1 rounded-md opacity-90 pointer-events-none transition-all duration-300 ease-[cubic-bezier(0.25,0.8,0.25,1)] z-0";
---

<div {...rest} class={`w-full max-w-4xl mx-auto ${className ?? ''}`}>
  
  {/* --- BARRA DE NAVEGACIÓN --- */}
  <div 
    id={`tab-bar-container-${id}`} 
    class="bg-gray-900/10 backdrop-blur-xl border-2 border-white/20 p-1 rounded-lg shadow-2xl relative tab-container-ref"
  >
    
    {/* Indicador Brillante (El color se asigna en el script) */}
    <div 
      id={`tab-indicator-${id}`}
      class={indicatorBaseStyle} 
      style="width: 0px; transform: translateX(0px); left: 0;"
    ></div>

    {/* Botones */}
    <div 
      class="relative grid gap-1 w-full z-10"
      style={`grid-template-columns: repeat(${tabs.length}, minmax(0, 1fr));`}
    >
      {tabs.map((tab) => (
        <button
          data-tab-id={tab.id}
          class="py-2.5 text-sm font-semibold rounded-md text-gray-400 hover:text-white hover:cursor-pointer transition-colors duration-200 whitespace-nowrap overflow-hidden text-ellipsis focus:outline-none w-full"
          aria-controls={`content-${tab.id}`}
        >
          {tab.label}
        </button>
      ))}
    </div>
  </div>

  {/* --- CONTENIDO DINÁMICO --- */}
  <div id={`tab-content-container-${id}`} class="mt-6 p-6 bg-gray-900/10 backdrop-blur-md border-2 border-white/20 rounded-lg shadow-xl tab-content-ref">
    <slot />
  </div>
</div>

{/* --- SCRIPTS --- */}
<script define:vars={{ initialTabId, uniqueId: id, baseStyle: indicatorBaseStyle }}>
  function initTabs() {
    const containerId = `tab-bar-container-${uniqueId}`;
    const indicatorId = `tab-indicator-${uniqueId}`;
    const contentId = `tab-content-container-${uniqueId}`;
    const storageKey = `tab-pos-${uniqueId}`;

    const container = document.getElementById(containerId);
    if (!container) return; 

    const indicator = document.getElementById(indicatorId);
    const contentContainer = document.getElementById(contentId);
    const buttons = container.querySelectorAll('button');
    
    // --- DEFINICIÓN DE COLORES PERSONALIZADOS ---
    const gradients = [
        // Izquierda: Naranja -> Rojo (Coincide con círculo superior izquierdo)
        "bg-gradient-to-r from-orange-500 to-red-800/20 shadow-md shadow-orange-900/30", 
        
        // creamos ese espacio "oscuro en medio de la página, lejos de ambos círculos"
        "bg-gradient-to-r from-red-800/20 to-blue-800/20 shadow-md shadow-gray-900/30", 
        
        // Derecha: azul -> Morado (Coincide con círculo inferior derecho)
        "bg-gradient-to-r from-blue-800/20 to-purple-600 shadow-md shadow-purple-900/30"
    ];

    // --- PERSISTENCIA ---
    const savedTabId = localStorage.getItem(storageKey);
    const isValidSaved = savedTabId && Array.from(buttons).some(b => b.dataset.tabId === savedTabId);
    let activeTab = isValidSaved ? savedTabId : initialTabId;

    // --- CÁLCULO DE POSICIÓN Y COLOR ---
    function updateIndicator(button) {
      if (!button || !indicator) return;
      
      const containerRect = container.getBoundingClientRect();
      const buttonRect = button.getBoundingClientRect();
      
      const borderOffset = container.clientLeft || 0;
      const translateX = buttonRect.left - containerRect.left - borderOffset;
      const width = buttonRect.width;

      // Mover
      indicator.style.width = `${width}px`;
      indicator.style.transform = `translateX(${translateX}px)`;

      // Color dinámico
      const index = Array.from(buttons).indexOf(button);
      const currentGradient = gradients[index] || gradients[gradients.length - 1];
      
      indicator.className = `${baseStyle} ${currentGradient}`;

      // Texto
      buttons.forEach(btn => {
        const isActive = btn === button;
        btn.classList.add('transition-all', 'duration-300'); // Suaviza el cambio de clases
        if (isActive) {
            btn.classList.add('delay-150', 'text-white', 'font-bold', 'border-white/30', 'border-2');
            btn.classList.remove('text-gray-400', 'border-transparent');
        } else {
            btn.classList.add('delay-100', 'text-gray-400', 'border-transparent');
            btn.classList.remove('text-white', 'font-bold', 'border-white/30', 'border-2');
        }
      });
    }

    function updateContent(tabId) {
      if (!contentContainer) return;
      const contents = contentContainer.querySelectorAll('[data-slot-id]');
      contents.forEach(c => c.style.display = 'none');
      
      const activeContent = contentContainer.querySelector(`[data-slot-id="${tabId}"]`);
      if (activeContent) {
          activeContent.style.display = 'block';
          activeContent.animate([
            { opacity: 0, transform: 'translateY(8px)' },
            { opacity: 1, transform: 'translateY(0)' }
        ], { duration: 250, easing: 'ease-out' });
      }
      
      activeTab = tabId;
      localStorage.setItem(storageKey, tabId); 
    }

    // --- RECALCULO AUTOMÁTICO ---
    const resizeObserver = new ResizeObserver(() => {
        const currentBtn = container.querySelector(`[data-tab-id="${activeTab}"]`);
        if (currentBtn) updateIndicator(currentBtn);
    });
    
    resizeObserver.observe(container);
    buttons.forEach(btn => resizeObserver.observe(btn));

    // --- INICIALIZACIÓN ---
    const startButton = container.querySelector(`[data-tab-id="${activeTab}"]`);
    if (startButton) {
        requestAnimationFrame(() => {
            updateIndicator(startButton);
            updateContent(activeTab);
        });
    }

    // --- LISTENERS ---
    buttons.forEach(button => {
      button.onclick = (e) => {
        const tabId = e.currentTarget.dataset.tabId;
        if (tabId === activeTab) return;
        updateIndicator(e.currentTarget);
        updateContent(tabId);
      };
    });
    
    document.addEventListener('astro:before-swap', () => {
        resizeObserver.disconnect();
    }, { once: true });
  }

  document.addEventListener('astro:page-load', initTabs);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTabs);
  } else {
    initTabs();
  }
</script>
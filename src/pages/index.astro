---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';
import ColorButton from '../components/ColorButton.astro';
import Section from '../components/Section.astro';
import TabBar from '../components/TabBar.astro';
import BentoGrid from '../components/BentoGrid.astro';
import StickyNav from '../components/StickyNav.astro';
import ExperienceTimeline from '../components/ExperienceTimeline.astro';

const miTrayectoria = [
  {
    date: "Agosto 2021 - Presente",
    company: "Instituto Tecnológico de Tepic",
    tag: "formative",
    role: "Estudiante",
    description: "Actualmente estoy cursando el último semestre de la carrera, con enfoque en desarrollo web"
  },
  {
    date: "Septiembre 2025 - Diciembre 2025",
    company: "Electronic Store Proyect",
    tag: "proyect",
    role: "Desarrollador Web",
    description: `
      Colaboré para desarrollar un sistema de ventas escalable, 
      reduciendo la carga manual operativa mediante la gestión automática de pagos y correos, 
      conectando React con un ecosistema de servicios modernos como Stripe, Firebase y FacturaApi.
      `
  },
  {
    date: "Enero 2025 - Junio 2025",
    company: "Mila Proyect",
    tag: "proyect",
    role: "Desarrollador Web",
    description: `
      Aporté identidad y diseño a la marca, mediante el uso de framworks modernos como 
      React y TailwindCSS, logrando una experiencia de usuario atractiva y funcional.
      `
  },
  {
    date: "Noviembre 2025 - Presente",
    company: "Google / Coursera",
    tag: "formative",
    role: "Certificación en UX/UI Design",
    description: `
      Desarrollando la capacidad de estandarizar interfaces complejas, 
      con el fin de reducir la deuda técnica visual en el desarrollo Frontend, 
      mediante la creación de sistemas de diseño y prototipos de alta fidelidad.
    `
  },
  
];

// Cargamos todos los archivos Markdown
const allWorks = await Astro.glob('./goals/*.md');

// Definimos las pestañas
const menuTabs = [
  {id: 'proyect', label: 'Proyectos'},
  {id: 'learn', label: 'Formación'},
  {id: 'ability', label: 'Habilidades'},
];

const socialDatas = {
    name: "Abisai Ruiz López",
    linkedin: "https://www.linkedin.com/in/abisai-ruiz/",
    github: "https://github.com/RuiloAbyss/",
    cv: "/CV_Abisai_Ruiz_Lopez.pdf"
};

const getWorksByCategory = (categoryId: string) => {
  return allWorks.filter(post => post.frontmatter.category === categoryId);
}
---

<Layout>
  <main>
    {/* Sección de Introducción */}
    <div id="profile-trigger" class="w-full flex flex-col lg:flex-row sm:items-stretch sm:justify-center gap-0"> 
        
        {/* Lado Izquierdo: Perfil */}
        <div class="w-full lg:flex-1 flex flex-col lg:pr-[20px]"> 
            {/* Añadimos flex-1 para que la sección crezca */}
            <Section class="flex-1 justify-center sm:justify-start">
                <div class="h-full flex flex-col sm:flex-row items-center sm:items-start justify-center gap-2"> 
                    <img
                        fetchpriority="high" 
                        src="/profile.webp" 
                        alt="Foto de Perfil" 
                        class=`
                        aspect-square w-[200px] sm:w-[170px] m-4 rounded-full sm:border-8 border-12 p-1 border-white/20 border-t-orange-900/80 border-r-orange-500/40
                        hover:scale-105 transition-all duration-500 ease-in-out
                        hover:border-white/60 hover:border-t-orange-800/60 hover:border-r-orange-400/60
                        `
                    />
                    <div class="flex flex-col mt-0 sm:mt-5 items-center sm:items-start text-center sm:w-full sm:text-left">
                        <h1 class="font-bold text-red-400">{socialDatas.name}</h1>
                        <h2 class="font-semibold text-white">Ing. En Sistemas</h2>
                        <p class="text-purple-400 font-bold animate-pulse">Un desarrollador web con sentido de diseño</p>
                    </div> 
                </div>
            </Section>
        </div> 

        {/* Lado Derecho: Links */}
        <div class="w-full lg:w-[25%] flex flex-col"> 
            {/* Añadimos flex-1 aquí también para igualar la altura */}
            <Section title="Links" class="flex-1 flex flex-col">
                <div class="flex justify-center lg:justify-center flex-row gap-1 w-full h-full lg:flex-col lg:gap-3"> 
                    <ColorButton 
                      label="Curriculum" 
                      theme="sunset" 
                      href={socialDatas.cv} 
                      aria-label="Descargar mi Curriculum en PDF"
                    />
                    <ColorButton 
                      label="LinkedIn" 
                      theme="void" 
                      href={socialDatas.linkedin} 
                      aria-label="Visitar mi perfil profesional en LinkedIn"
                    />
                    <ColorButton 
                      label="GitHub" 
                      theme="cosmic" 
                      href={socialDatas.github} 
                      aria-label="Explorar mis proyectos de código abierto en GitHub"
                    />
                </div>
            </Section>
        </div>
    </div>
	
    {/* Sección de Trayectoria Profesional */}
    <Section title="Formación y Proyectos" id="experience-trigger" class="mb-5">
        <ExperienceTimeline experiences={miTrayectoria} />  
    </Section>

    {/* --- TabBar con Bento Grid Integrado --- */}
    <div id="tabbar-trigger"></div>
        <TabBar tabs={menuTabs} initialTabId="dev" theme="sunset" class="my-2">
            {menuTabs.map((tab) => {
                const works = getWorksByCategory(tab.id);
                
                // Convertimos el formato de Markdown al formato plano que espera BentoGrid/Card
                const bentoItems = works.map(post => ({
                    title: post.frontmatter.title,
                    imglink: post.frontmatter.image,     
                    content: post.frontmatter.description, 
                    href: post.url,                    
                    theme: post.frontmatter.theme,
                    technologies: post.frontmatter.tags || []
                }));

                // Lógica de visualización
                const initialDisplay = tab.id === 'dev' ? 'block' : 'none'; 

                return (
                    <div 
                        data-slot-id={tab.id} 
                        style={`display: ${initialDisplay};`} 
                    >
                        {works.length > 0 ? (
                            // Aquí simplemente pasamos los items procesados
                            <BentoGrid items={bentoItems} />
                        ) : (
                            <div class="text-center py-10 opacity-50">
                                <p>Próximamente más proyectos en esta categoría.</p>
                            </div>
                        )}
                    </div>
                );
            })}
        </TabBar>
    </div>
    </main>
    {/* Agregamos el componente nuevo al final */}
    <StickyNav 
        socialDatas={socialDatas}
        tabs={menuTabs}
    />
</Layout>

<script>
  function initScrollReveal() {
  const observerOptions = { threshold: 0.1 };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add('active');
      } else {
        entry.target.classList.remove('active');
      }
    });
  }, observerOptions);

  // Elementos con ZOOM (Perfil, Cards, Trayectoria)
  const zoomElements = document.querySelectorAll(
    'section, .relative.flex.w-full.pb-12, a.block.group, #profile-trigger > div'
  );
  zoomElements.forEach((el) => {
    el.classList.add('reveal');
    observer.observe(el);
  });

  // Elementos con SOLO FADE (Contenedores de la TabBar)
  const fadeElements = document.querySelectorAll('.tab-container-ref, .tab-content-ref');
  fadeElements.forEach((el) => {
    el.classList.add('reveal-fade');
    observer.observe(el);
  });
}

  document.addEventListener('astro:page-load', initScrollReveal);
  
  // Respaldo para la primera carga
  document.addEventListener('DOMContentLoaded', initScrollReveal);
</script>
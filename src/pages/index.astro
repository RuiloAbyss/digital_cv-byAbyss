---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';
import ColorButton from '../components/ColorButton.astro';
import Section from '../components/Section.astro';
import TabBar from '../components/TabBar.astro';
import BentoGrid from '../components/BentoGrid.astro';
import StickyNav from '../components/StickyNav.astro';
import ExperienceTimeline from '../components/ExperienceTimeline.astro';
import ProjectCard from '../components/ProjectCard.astro';

import { universityData, topExperience, menuTabs, socialData } from '../data/portfolio';

// Cargamos todos los archivos Markdown
const allWorks = Object.values(import.meta.glob('./goals/*.md', { eager: true })) as any[];

// Filtramos los proyectos
const projects = allWorks.filter(p => p.frontmatter.category === 'proyect');

const getWorksByCategory = (categoryId: string) => {
  return allWorks.filter((post) => post.frontmatter?.category === categoryId);
}

---
{/*============================================================================*/}
<Layout>
  <main>
    {/* Sección de Introducción */}
    <div id="profile-trigger" class="w-full flex flex-col lg:flex-row sm:items-stretch sm:justify-center gap-0"> 
      
      {/* Lado Izquierdo: Perfil */}
      <div class="w-full lg:flex-1 flex flex-col lg:pr-[20px]"> 
        <Section class="flex-1 justify-center sm:justify-start mb-5">
          <div class="h-full flex flex-col sm:flex-row items-center sm:items-start justify-center gap-2"> 
            
            {/* Foto de perfil */}  
              <img
                fetchpriority="high" 
                src="/profile.webp" 
                alt="Foto de Perfil" 
                class=`
                aspect-square w-[200px] sm:w-[170px] m-4 rounded-full sm:border-8 border-12 p-1 border-white/20 border-t-orange-900/80 border-r-orange-500/40
                hover:scale-105 transition-all duration-500 ease-in-out
                hover:border-white/60 hover:border-t-orange-800/60 hover:border-r-orange-400/60
                `
            />

            {/* Texto de perfil */}
            <div class="flex flex-col mt-0 sm:mt-5 items-center sm:items-start text-center sm:w-full sm:text-left">
                <h1 class="font-bold text-red-400">{socialData.name}</h1>
                <h2 class="font-semibold text-white">Ing. En Sistemas</h2>
                <p class="text-purple-400 font-bold animate-pulse">Un Desarrollador Web Con Sentido De Diseño</p>
            </div> 

          </div>
        </Section>
      </div> 

        {/* Lado Derecho: Links */}
        <div class="w-full lg:w-[25%] flex flex-col"> 
            <Section title="Links" class="flex-1 flex flex-col mb-5">
                <div class="flex justify-center lg:justify-center flex-row gap-1 w-full h-full lg:flex-col lg:gap-3"> 
                    <ColorButton 
                      label="Curriculum" 
                      theme="sunset" 
                      href={socialData.cv} 
                      aria-label="Descargar mi Curriculum en PDF"
                    />
                    <ColorButton 
                      label="LinkedIn" 
                      theme="void" 
                      href={socialData.linkedin} 
                      aria-label="Visitar mi perfil profesional en LinkedIn"
                    />
                    <ColorButton 
                      label="GitHub" 
                      theme="cosmic" 
                      href={socialData.github} 
                      aria-label="Explorar mis proyectos de código abierto en GitHub"
                    />
                </div>
            </Section>
        </div>
    </div>
	
    {/*About Me | Education*/}
      <div class="flex flex-col lg:flex-row gap-5 pb-5">
        
        {/* About Me*/}
        <Section title="Sobre Mí" class="prose prose-slate text-white leading-relaxed text-pretty text-left">
          <p>
            Especialista en Desarrollo Web y UX/UI. Creo en el diseño como una herramienta 
            para construir espacios digitales agradables y funcionales. 
          </p>
          <p>
            Mi objetivo es lograr el equilibrio perfecto: interfaces atractivas 
            que no comprometan el rendimiento.
          </p>
          <p>
            Apasionado por el arte y la identidad visual, ayudo a las marcas a crear 
            experiencias digitales inolvidables.
          </p>
        </Section>

        {/* Education */}
        <Section title="Educación">
          <a href="https://www.ittepic.edu.mx/" target="_blank" rel="noopener noreferrer" class="block group">
            <div class="bg-white/10 p-4 rounded-lg shadow-md border-2 border-white/10 hover:border-white/30">
              <h4 class="font-bold text-orange-400">{universityData.institution}</h4>
              <p class="italic text-purple-400">{universityData.degree}</p>
              <p class="text-sm text-gray-300">{universityData.date}</p>
              <p class="mt-2 text-white text-center leading-relaxed">{universityData.description}</p>
            </div>
          </a>
        </Section>

      </div>

    {/* Sección de Trayectoria Profesional */}
    <Section title="Experiencia" id="experience-trigger" class="p-2 mb-5"}>
      <ExperienceTimeline experiences={topExperience as any} />  
    </Section>

    <Section title="Proyectos Destacados" id="dedicated-projects" class="mb-10">
      <div class="flex flex-col w-full">
        {projects.map((proj) => (
          <ProjectCard 
            title={proj.frontmatter.title}
            imglink={proj.frontmatter.image}
            content={proj.frontmatter.description}
            technologies={proj.frontmatter.tags || []}
            href={proj.frontmatter.href}
            theme={proj.frontmatter.theme}
          />
        ))}
      </div>
    </Section>

    {/* Sección de Formación | SS | HS */}
    <Section title="Formación y Habilidades" id="projects-formation-trigger" class="mb-5">

        <TabBar id="tabbar-trigger" tabs={menuTabs} initialTabId="dev" theme="sunset" class="my-2">
            {menuTabs.map((tab) => {
                const works = getWorksByCategory(tab.id);
                
                // Convertimos el formato de Markdown al formato plano que espera BentoGrid/Card
                const bentoItems = works.map((post: any) => ({
                    title: post.frontmatter.title,
                    imglink: post.frontmatter.image,     
                    content: post.frontmatter.description, 
                    href: post.frontmatter.href,                   
                    theme: post.frontmatter.theme,
                    technologies: post.frontmatter.tags || [],
                    span: post.frontmatter.span || 1
                }));

                // Lógica de visualización
                const initialDisplay = tab.id === 'dev' ? 'block' : 'none'; 

                return (
                    <div 
                        data-slot-id={tab.id} 
                        style={`display: ${initialDisplay};`} 
                    >
                        {works.length > 0 ? (
                            // Aquí simplemente pasamos los items procesados
                            <BentoGrid items={bentoItems} />
                        ) : (
                            <div class="text-center py-10 opacity-50">
                                <p>Próximamente más proyectos en esta categoría.</p>
                            </div>
                        )}
                    </div>
                );
            })}
        </TabBar>
    </Section>
    </main>

    {/* Sticky bars */}
    <StickyNav 
        socialDatas={socialData}
    />
</Layout>

{/*============================================================================*/}
<script>
  function initScrollReveal() {
  const observerOptions = { threshold: 0.1 };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add('active');
      } else {
        entry.target.classList.remove('active');
      }
    });
  }, observerOptions);

  // Elementos con ZOOM (Perfil, Cards, Trayectoria)
  const zoomElements = document.querySelectorAll(
    'section, .relative.flex.w-full.pb-3, a.block.group, #profile-trigger > div'
  );
  zoomElements.forEach((el) => {
    el.classList.add('reveal');
    observer.observe(el);
  });

  // Elementos con SOLO FADE (Contenedores de la TabBar)
  const fadeElements = document.querySelectorAll('.tab-container-ref, .tab-content-ref');
  fadeElements.forEach((el) => {
    el.classList.add('reveal-fade');
    observer.observe(el);
  });
}

  document.addEventListener('astro:page-load', initScrollReveal);
  
  // Respaldo para la primera carga
  document.addEventListener('DOMContentLoaded', initScrollReveal);
</script>
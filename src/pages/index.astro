---
import Layout from '../layouts/Layout.astro';
import '../styles/global.css';
import ColorButton from '../components/ColorButton.astro';
import Section from '../components/Section.astro';
import TabBar from '../components/TabBar.astro';
import BentoGrid from '../components/BentoGrid.astro';
import StickyNav from '../components/StickyNav.astro';
import ExperienceTimeline from '../components/ExperienceTimeline.astro';

const miTrayectoria = [
  {
    date: "Enero 2024 - Presente",
    company: "Freelance Tech",
    role: "Lead Front-End Developer",
    description: "Desarrollo de interfaces reactivas utilizando Astro y Tailwind, optimizando el rendimiento de carga en un 40%."
  },
  {
    date: "Junio 2023 - Diciembre 2023",
    company: "Design Studio X",
    role: "UX/UI Designer",
    description: "Creación de prototipos de alta fidelidad y sistemas de diseño que mejoraron la consistencia visual de la marca."
  }
];

// Cargamos todos los archivos Markdown
const allWorks = await Astro.glob('./works/*.md');

// Definimos las pestañas
const menuTabs = [
  {id: 'dev', label: 'Desarrollo Web'},
  {id: 'design', label: 'Diseño UX/UI'},
  {id: 'content', label: 'Contenido Digital'},
];

const misRedes = {
    linkedin: "https://www.linkedin.com/in/abisai-ruiz/",
    github: "https://github.com/RuiloAbyss/",
    cv: "/CV_Abisai_Ruiz Lopez.pdf"
};

const getWorksByCategory = (categoryId: string) => {
  return allWorks.filter(post => post.frontmatter.category === categoryId);
}
---

<Layout>
  <main>
    {/* Sección de Introducción */}
    <div id="profile-trigger" class="w-full flex flex-col sm:flex-row sm:items-stretch sm:justify-center gap-0"> 
        
        {/* Lado Izquierdo: Perfil */}
        <div class="w-full sm:flex-1 flex flex-col sm:pr-[20px]"> 
            {/* Añadimos flex-1 para que la sección crezca */}
            <Section class="flex-1 justify-center sm:justify-start">
                <div class="h-full flex flex-col sm:flex-row items-center sm:items-start justify-center gap-2"> 
                    <img
                        fetchpriority="high" 
                        src="/profile.webp" 
                        alt="Foto de Perfil" 
                        class=`
                        aspect-square w-[200px] sm:w-[170px] m-4 rounded-full sm:border-8 border-12 p-1 border-white/20 border-t-orange-900/80 border-r-orange-500/40
                        hover:scale-105 transition-all duration-500 ease-in-out
                        hover:border-white/60 hover:border-t-orange-800/60 hover:border-r-orange-400/60
                        `
                    />
                    <div class="flex flex-col mt-0 sm:mt-5 items-center sm:items-start text-center sm:w-full sm:text-left">
                        <h3 class="font-bold text-white">Abisai Ruiz López</h3>
                        <h5 class="text-red-400 font-bold animate-pulse">Front-End Developer</h5>
                        <p class="text-white">Un desarrollador web con sentido de diseño</p>
                    </div> 
                </div>
            </Section>
        </div> 

        {/* Lado Derecho: Links */}
        <div class="w-full sm:w-[25%] flex flex-col"> 
            {/* Añadimos flex-1 aquí también para igualar la altura */}
            <Section title="Links" class="flex-1 flex flex-col">
                <div class="flex justify-center sm:justify-center flex-row gap-1 w-full h-full sm:flex-col sm:gap-3"> 
                    <ColorButton 
                      label="Curriculum" 
                      theme="sunset" 
                      href={misRedes.cv} 
                      aria-label="Descargar mi Curriculum en PDF"
                    />
                    <ColorButton 
                      label="LinkedIn" 
                      theme="void" 
                      href={misRedes.linkedin} 
                      aria-label="Visitar mi perfil profesional en LinkedIn"
                    />
                    <ColorButton 
                      label="GitHub" 
                      theme="cosmic" 
                      href={misRedes.github} 
                      aria-label="Explorar mis proyectos de código abierto en GitHub"
                    />
                </div>
            </Section>
        </div>
    </div>
	
    {/* Sección de Trayectoria Profesional */}
    <Section title="Mi Trayectoria" id="experience-trigger" class="mb-5">
        <ExperienceTimeline experiences={miTrayectoria} />
    </Section>

    {/* --- TabBar con Bento Grid Integrado --- */}
    <div id="tabbar-trigger"></div>
        <TabBar tabs={menuTabs} initialTabId="dev" theme="sunset" class="my-2">
            {menuTabs.map((tab) => {
                const works = getWorksByCategory(tab.id);
                
                // Convertimos el formato de Markdown al formato plano que espera BentoGrid/Card
                const bentoItems = works.map(post => ({
                    title: post.frontmatter.title,
                    imglink: post.frontmatter.image,     
                    content: post.frontmatter.description, 
                    href: post.url,                    
                    theme: post.frontmatter.theme,
                    technologies: post.frontmatter.tags || []
                }));

                // Lógica de visualización
                const initialDisplay = tab.id === 'dev' ? 'block' : 'none'; // Usamos block en lugar de grid, porque BentoGrid ya tiene su propio grid

                return (
                    <div 
                        data-slot-id={tab.id} 
                        style={`display: ${initialDisplay};`} 
                    >
                        {works.length > 0 ? (
                            // Aquí simplemente pasamos los items procesados
                            <BentoGrid items={bentoItems} />
                        ) : (
                            <div class="text-center py-10 opacity-50">
                                <p>Próximamente más proyectos en esta categoría.</p>
                            </div>
                        )}
                    </div>
                );
            })}
        </TabBar>
    </div>
    </main>
    {/* Agregamos el componente nuevo al final */}
    <StickyNav 
        name="Abisai Ruiz López"
        socialLinks={misRedes}
        tabs={menuTabs}
    />
</Layout>

<script>
  function initScrollReveal() {
  const observerOptions = { threshold: 0.1 };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add('active');
      } else {
        entry.target.classList.remove('active');
      }
    });
  }, observerOptions);

  // Elementos con ZOOM (Perfil, Cards, Trayectoria)
  const zoomElements = document.querySelectorAll(
    'section, .relative.flex.w-full.pb-12, a.block.group, #profile-trigger > div'
  );
  zoomElements.forEach((el) => {
    el.classList.add('reveal');
    observer.observe(el);
  });

  // Elementos con SOLO FADE (Contenedores de la TabBar)
  const fadeElements = document.querySelectorAll('.tab-container-ref, .tab-content-ref');
  fadeElements.forEach((el) => {
    el.classList.add('reveal-fade');
    observer.observe(el);
  });
}

  document.addEventListener('astro:page-load', initScrollReveal);
  
  // Respaldo para la primera carga
  document.addEventListener('DOMContentLoaded', initScrollReveal);
</script>